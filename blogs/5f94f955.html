<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="GET 设置查询参数  1https:&#x2F;&#x2F;www.juphy.cn&#x2F;todos?_page=1&amp;amp;_limit=10    创建HttpParams对象   直接链式创建 12345import &amp;#123; HttpClient, HttpParams &amp;#125; from &amp;apos;@angular&#x2F;common&#x2F;http&amp;apos;;const params = new HttpP">
<meta name="keywords" content="Angular,http">
<meta property="og:type" content="article">
<meta property="og:title" content="Angular中的http请求">
<meta property="og:url" content="http:&#x2F;&#x2F;blog.juphy.cn&#x2F;blogs&#x2F;5f94f955.html">
<meta property="og:site_name" content="挽留之王小石">
<meta property="og:description" content="GET 设置查询参数  1https:&#x2F;&#x2F;www.juphy.cn&#x2F;todos?_page=1&amp;amp;_limit=10    创建HttpParams对象   直接链式创建 12345import &amp;#123; HttpClient, HttpParams &amp;#125; from &amp;apos;@angular&#x2F;common&#x2F;http&amp;apos;;const params = new HttpP">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-09-06T03:06:43.823Z">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.juphy.cn/blogs/5f94f955.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Angular中的http请求 | 挽留之王小石</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="挽留之王小石" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">挽留之王小石</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Hello,world!</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.juphy.cn/blogs/5f94f955.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Juphy">
      <meta itemprop="description" content="挽留天涯挽留人,挽留岁月挽留你。它就是挽留,我就是使挽留的人,只看谁是要被挽留。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="挽留之王小石">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Angular中的http请求
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-09-05 14:56:00" itemprop="dateCreated datePublished" datetime="2018-09-05T14:56:00+08:00">2018-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-09-06 11:06:43" itemprop="dateModified" datetime="2018-09-06T11:06:43+08:00">2018-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h2><blockquote>
<p>设置查询参数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.juphy.cn/todos?_page=1&amp;_limit=10</span><br></pre></td></tr></table></figure>


<blockquote>
<p>创建HttpParams对象</p>
</blockquote>
<ol>
<li><p>直接链式创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import &#123; HttpClient, HttpParams &#125; from &apos;@angular/common/http&apos;;</span><br><span class="line"></span><br><span class="line">const params = new HttpParams().set(&apos;_page&apos;, 1).set(&apos;_limit&apos;, 10);</span><br><span class="line"></span><br><span class="line">this.http.get(&apos;https://www.juphy.cn/todos&apos;, &#123;params&#125;);</span><br></pre></td></tr></table></figure>
<p>通过链式语法调用 set() 方法，构建 HttpParams 对象。这是因为HttpParams对象是不可变的，通过set() 方法可以防止该对象被修改。每当调用 set() 方法，将会返回包含新值的 HttpParams 对象。</p>
</li>
<li><p>使用formString</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const params = new HttpParams(&#123;formString: &apos;_page=1&amp;_limit=10&apos;&#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用formObject</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const params = new HttpParams(&#123; fromObject: &#123; _page: &quot;1&quot;, _limit: &quot;10&quot; &#125; &#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用request API</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.http.request(&apos;GET&apos;, &apos;https://www.juphy.cn/todos&apos;, &#123;params&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="获取完整响应"><a href="#获取完整响应" class="headerlink" title="获取完整响应"></a>获取完整响应</h2><p>默认情况下，httpClient服务返回的是响应体，如果需要获取响应头的相关信息，可以设置options的对象的observe属性值为response来获取完整的响应对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">this.http.get(&apos;https://www.juphy.cn/todos&apos;,&#123;</span><br><span class="line">    observe: &apos;response&apos;</span><br><span class="line">&#125;).subscribe(res =&gt; &#123;</span><br><span class="line">    console.dir(&apos;Response:&apos;+res.status);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="设置响应类型"><a href="#设置响应类型" class="headerlink" title="设置响应类型"></a>设置响应类型</h2><p>options设置responseType属性的值，’text’,’arraybuffer’,’blob’。</p>
<h2 id="设置Http-Headers"><a href="#设置Http-Headers" class="headerlink" title="设置Http Headers"></a>设置Http Headers</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const params = new HttpParams(&#123; fromObject: &#123; _page: &quot;1&quot;, _limit: &quot;10&quot; &#125; &#125;);</span><br><span class="line">const headers = new HttpHeaders().set(&apos;Content-Type&apos;, &apos;application/json; charset=UTF-8&apos;);</span><br><span class="line">this.http.get(&apos;url&apos;, &#123;headers, params&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="多个http请求"><a href="#多个http请求" class="headerlink" title="多个http请求"></a>多个http请求</h2><h3 id="并行发送"><a href="#并行发送" class="headerlink" title="并行发送"></a>并行发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const parallel$ = forkJoin(</span><br><span class="line">    this.http.get(&apos;url1&apos;),</span><br><span class="line">    this.http.get(&apos;url2&apos;)</span><br><span class="line">);</span><br><span class="line">parallel$.subscribe(res =&gt;&#123;</span><br><span class="line">    res是一个数组包含多个请求返回的结果。</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="顺序发送"><a href="#顺序发送" class="headerlink" title="顺序发送"></a>顺序发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const sequence$ = this.http.get(&apos;url1&apos;)</span><br><span class="line">    .pipe(</span><br><span class="line">        switchMap(res =&gt;&#123;</span><br><span class="line">            // 此res是url1返回的结果</span><br><span class="line">            return this.http.get(&apos;url2&apos;);</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">    sequence$.subscribe(res=&gt;&#123;</span><br><span class="line">        res// 此res是url2返回的结果</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="控制返回结果"><a href="#控制返回结果" class="headerlink" title="控制返回结果"></a>控制返回结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const sequence$ = this.http.get(&apos;url1&apos;)</span><br><span class="line">    .pipe(</span><br><span class="line">        switchMap(res =&gt;&#123;</span><br><span class="line">            // 此res是url1返回的结果</span><br><span class="line">            return this.http.get(&apos;url2&apos;);</span><br><span class="line">        &#125;, (res1, res2) =&gt; [res1, res2]) // 此处控制返回结果</span><br><span class="line">    );</span><br><span class="line">    sequence$.subscribe(res=&gt;&#123;</span><br><span class="line">        res; // [res1, res2]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="请求异常处理"><a href="#请求异常处理" class="headerlink" title="请求异常处理"></a>请求异常处理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; of &#125; from &quot;rxjs&quot;;</span><br><span class="line">import &#123; catchError &#125; from &quot;rxjs/operators&quot;;</span><br><span class="line"></span><br><span class="line">this.http.get(&apos;url&apos;).pipe(</span><br><span class="line">    catchError(error =&gt; &#123;</span><br><span class="line">        console.error(&apos;Error catched&apos;, error);</span><br><span class="line">        return of(&#123;description: &apos;Error Value Emitted&apos;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">).subscribe(res =&gt; console.log(res));</span><br></pre></td></tr></table></figure>

<h2 id="Http拦截器"><a href="#Http拦截器" class="headerlink" title="Http拦截器"></a>Http拦截器</h2><h3 id="定义拦截器"><a href="#定义拦截器" class="headerlink" title="定义拦截器"></a>定义拦截器</h3><p>拦截器提供了一种用于拦截、修改请求和响应的机制，类似于express中间件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Injectable &#125; from &quot;@angular/core&quot;;</span><br><span class="line">import &#123; HttpEvent, HttpRequest, HttpHandler, HttpInterceptor &#125; from &quot;@angular/common/http&quot;;</span><br><span class="line">import &#123; Observable, of, throwError &#125; from &apos;rxjs&apos;;</span><br><span class="line">import &#123; mergeMap, catchError &#125; from &apos;rxjs/operators&apos;;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line">// 定义一个类并实现HttpInterceptor接口</span><br><span class="line">export class DefaultInterceptor implements HttpInterceptor &#123;</span><br><span class="line">  constructor(private injector: Injector)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  private handleData(</span><br><span class="line">    event: HttpResponse&lt;any&gt; | HttpErrorResponse</span><br><span class="line">  ): Observable&lt;any&gt;&#123;</span><br><span class="line">    console.log(event);</span><br><span class="line">    switch(event.status)&#123;</span><br><span class="line">        case 200:</span><br><span class="line">        break;</span><br><span class="line">        case 401:</span><br><span class="line">        break;</span><br><span class="line">        case 403:</span><br><span class="line">        break;</span><br><span class="line">        case 404:</span><br><span class="line">        break;</span><br><span class="line">        case 500:</span><br><span class="line">        break;</span><br><span class="line">        default:</span><br><span class="line">            if(event instanceof HttpErrorResponse)&#123;</span><br><span class="line">                console.warn(</span><br><span class="line">                    &apos;未可知错误，大部分是由于后端不支持CORS或无效配置引起&apos;,</span><br><span class="line">                    event</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return of(event);</span><br><span class="line">  &#125;</span><br><span class="line">  intercept(</span><br><span class="line">    req: HttpRequest&lt;any&gt;, // HttpRequest，即请求对象</span><br><span class="line">    next: HttpHandler // HttpHandler，该对象有一个handle()方法，该方法返回一个Observable对象。</span><br><span class="line">  ): Observable&lt;HttpEvent&lt;any&gt;&gt; &#123;</span><br><span class="line">     let url= req.url; // 设置url形式，统一加上服务端前缀</span><br><span class="line">     const newReq = req.clone(</span><br><span class="line">        url: url,</span><br><span class="line">        headers: req.headers.set(&quot;X-CustomAuthHeader&quot;, &quot;iloveangular&quot;)</span><br><span class="line">     );</span><br><span class="line">     return next.handle(newReq).pipe(</span><br><span class="line">        mergeMap((event: any) =&gt; &#123;</span><br><span class="line">            // 允许统一对请求错误进行处理，这是因为一个请求若是业务上错误的情况下其HTTP请求的状态是200的情况下需要</span><br><span class="line">            if(event instanceof HttpReponse &amp;&amp; event.status === 200) return this.handleData(event);</span><br><span class="line">            // 若一切正常，则后续操作</span><br><span class="line">            return of(event);</span><br><span class="line">        &#125;),</span><br><span class="line">        catchError((err: HttpErrorResponse) =&gt; this.handleData(err))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CachingInterceptor"><a href="#CachingInterceptor" class="headerlink" title="CachingInterceptor"></a>CachingInterceptor</h3><p>拦截器实现简单的缓存控制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">定义一个Cache接口：</span><br><span class="line">import &#123; HttpRequest, HttpResponse &#125; from &apos;@angular/common/http&apos;;</span><br><span class="line"></span><br><span class="line">export interface Cache &#123;</span><br><span class="line">  get(req: HttpRequest&lt;any&gt;): HttpResponse&lt;any&gt; | null;</span><br><span class="line">  put(req: HttpRequest&lt;any&gt;, res: HttpResponse&lt;any&gt;): void;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>get(req: HttpRequest): HttpResponse | null —— 用于获取 req 请求对象对应的响应对象；</li>
<li>put(req: HttpRequest, res: HttpResponse): void; —— 用于保存 req 对象对应的响应对象。</li>
</ul>
<p>在实际的场景中，一般会设置一个最大的缓存时间，即缓存的有效期，在有效期内，如果缓存存在，则会直接返回已缓存的响应对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; HttpResponse &#125; from &quot;@angular/common/http&quot;;</span><br><span class="line"></span><br><span class="line">export const MAX_CACHE_AGE = 30000; // 单位为毫秒</span><br><span class="line"></span><br><span class="line">export interface CacheEntry &#123;</span><br><span class="line">  url: string;</span><br><span class="line">  response: HttpResponse&lt;any&gt;;</span><br><span class="line">  entryTime: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>url: string —— 被缓存的请求 URL 地址</li>
<li>response: HttpResponse —— 被缓存的响应对象</li>
<li>entryTime: number —— 响应对象被缓存的时间，用于判断缓存是否过期</li>
</ul>
<p>实现CacheService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Injectable &#125; from &quot;@angular/core&quot;;</span><br><span class="line">import &#123; HttpRequest, HttpResponse &#125; from &quot;@angular/common/http&quot;;</span><br><span class="line">import &#123; Cache &#125; from &quot;./cache&quot;;</span><br><span class="line">import &#123; CacheEntry, MAX_CACHE_AGE &#125; from &quot;./cache.entry&quot;;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: &quot;root&quot;</span><br><span class="line">&#125;)</span><br><span class="line">export class CacheService implements Cache &#123;</span><br><span class="line">  cacheMap = new Map&lt;string, CacheEntry&gt;();</span><br><span class="line"></span><br><span class="line">  constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  get(req: HttpRequest&lt;any&gt;): HttpResponse&lt;any&gt; | null &#123;</span><br><span class="line">    // 判断当前请求是否已被缓存，若未缓存则返回null</span><br><span class="line">    const entry = this.cacheMap.get(req.urlWithParams);</span><br><span class="line">    if (!entry) return null;</span><br><span class="line">    // 若缓存存在，则判断缓存是否过期，若已过期则返回null。否则返回请求对应的响应对象</span><br><span class="line">    const isExpired = Date.now() - entry.entryTime &gt; MAX_CACHE_AGE;</span><br><span class="line">    console.log(`req.urlWithParams is Expired: $&#123;isExpired&#125; `);</span><br><span class="line">    return isExpired ? null : entry.response;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  put(req: HttpRequest&lt;any&gt;, res: HttpResponse&lt;any&gt;): void &#123;</span><br><span class="line">    // 创建CacheEntry对象</span><br><span class="line">    const entry: CacheEntry = &#123;</span><br><span class="line">      url: req.urlWithParams,</span><br><span class="line">      response: res,</span><br><span class="line">      entryTime: Date.now()</span><br><span class="line">    &#125;;</span><br><span class="line">    console.log(`Save entry.url response into cache`);</span><br><span class="line">    // 以请求url作为键，CacheEntry对象为值，保存到cacheMap中。并执行</span><br><span class="line">    // 清理操作，即清理已过期的缓存。</span><br><span class="line">    this.cacheMap.set(req.urlWithParams, entry);</span><br><span class="line">    this.deleteExpiredCache();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private deleteExpiredCache() &#123;</span><br><span class="line">    this.cacheMap.forEach(entry =&gt; &#123;</span><br><span class="line">      if (Date.now() - entry.entryTime &gt; MAX_CACHE_AGE) &#123;</span><br><span class="line">        this.cacheMap.delete(entry.url);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现CachingInterceptor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import &#123; CacheService &#125; from &apos;../cache.service&apos;;</span><br><span class="line">const CACHABLE_URL = &apos;url&apos;;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line">export class CachingInterceptor implements HttpInterceptor &#123;</span><br><span class="line">    constructor(private cache: CacheService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler) &#123;</span><br><span class="line">        // 判断当前请求是否可缓存</span><br><span class="line">        if (!this.isRequestCachable(req)) &#123;</span><br><span class="line">           return next.handle(req);</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取请求对应的缓存对象，若存在则直接返回该请求对象对应的缓存对象</span><br><span class="line">        const cachedResponse = this.cache.get(req);</span><br><span class="line">        if (cachedResponse !== null) &#123;</span><br><span class="line">           return of(cachedResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        // 发送请求至API站点，请求成功后保存至缓存中</span><br><span class="line">        return next.handle(req).pipe(</span><br><span class="line">           tap(event =&gt; &#123;</span><br><span class="line">              if (event instanceof HttpResponse) &#123;</span><br><span class="line">                this.cache.put(req, event);</span><br><span class="line">              &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 判断当前请求是否可缓存</span><br><span class="line">    private isRequestCachable(req: HttpRequest&lt;any&gt;) &#123;</span><br><span class="line">        return (req.method === &apos;GET&apos;) &amp;&amp; (req.url.indexOf(CACHABLE_URL) &gt; -1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="应用拦截器"><a href="#应用拦截器" class="headerlink" title="应用拦截器"></a>应用拦截器</h3><p>app.module.ts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import DefaultInterceptor</span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [AppComponent],</span><br><span class="line">  imports: [BrowserModule, HttpClientModule],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123; provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true &#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line">export class AppModule &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Http进度事件"><a href="#Http进度事件" class="headerlink" title="Http进度事件"></a>Http进度事件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">this.http.get(&apos;url&apos;, &#123;</span><br><span class="line">    observe: &apos;events&apos;,</span><br><span class="line">    reportProgress: true</span><br><span class="line">&#125;).subscribe((event: HttpEvent&lt;any&gt;) =&gt; &#123;</span><br><span class="line">    switch(event.type)&#123;</span><br><span class="line">          case HttpEventType.Sent:</span><br><span class="line">            console.log(&quot;Request sent!&quot;);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.ResponseHeader:</span><br><span class="line">            console.log(&quot;Response header received!&quot;);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.DownloadProgress:</span><br><span class="line">            const kbLoaded = Math.round(event.loaded / 1024);</span><br><span class="line">            console.log(`Download in progress! $&#123;kbLoaded&#125;Kb loaded`);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.Response:</span><br><span class="line">            console.log(&quot;Done!&quot;, event.body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Request sent!</span><br><span class="line">Response header received!</span><br><span class="line">Download in progress! 6Kb loaded</span><br><span class="line">Download in progress! 24Kb loaded</span><br><span class="line">Done!</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">this.http.get(&apos;url&apos;, &#123;</span><br><span class="line">    observe: &apos;events&apos;,</span><br><span class="line">    reportProgress: true</span><br><span class="line">&#125;).subscribe((event: HttpEvent&lt;any&gt;) =&gt; &#123;</span><br><span class="line">    switch(event.type)&#123;</span><br><span class="line">          case HttpEventType.Sent:</span><br><span class="line">            console.log(&quot;Request sent!&quot;);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.ResponseHeader:</span><br><span class="line">            console.log(&quot;Response header received!&quot;);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.DownloadProgress:</span><br><span class="line">            const kbLoaded = Math.round(event.loaded / 1024);</span><br><span class="line">            console.log(`Download in progress! $&#123;kbLoaded&#125;Kb loaded`);</span><br><span class="line">            break;</span><br><span class="line">          case HttpEventType.Response:</span><br><span class="line">            console.log(&quot;Done!&quot;, event.body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Request sent!</span><br><span class="line">Response header received!</span><br><span class="line">Download in progress! 6Kb loaded</span><br><span class="line">Download in progress! 24Kb loaded</span><br><span class="line">Done!</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Angular/" rel="tag"># Angular</a>
              <a href="/tags/http/" rel="tag"># http</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/blogs/1e68471e.html" rel="next" title="JavaScript读写excel文件">
                  <i class="fa fa-chevron-left"></i> JavaScript读写excel文件
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/blogs/5adc8916.html" rel="prev" title="Angular中的ng-content使用">
                  Angular中的ng-content使用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GET"><span class="nav-number">1.</span> <span class="nav-text">GET</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取完整响应"><span class="nav-number">2.</span> <span class="nav-text">获取完整响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置响应类型"><span class="nav-number">3.</span> <span class="nav-text">设置响应类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置Http-Headers"><span class="nav-number">4.</span> <span class="nav-text">设置Http Headers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多个http请求"><span class="nav-number">5.</span> <span class="nav-text">多个http请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#并行发送"><span class="nav-number">5.1.</span> <span class="nav-text">并行发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#顺序发送"><span class="nav-number">5.2.</span> <span class="nav-text">顺序发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制返回结果"><span class="nav-number">5.3.</span> <span class="nav-text">控制返回结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求异常处理"><span class="nav-number">6.</span> <span class="nav-text">请求异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http拦截器"><span class="nav-number">7.</span> <span class="nav-text">Http拦截器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义拦截器"><span class="nav-number">7.1.</span> <span class="nav-text">定义拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CachingInterceptor"><span class="nav-number">7.2.</span> <span class="nav-text">CachingInterceptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用拦截器"><span class="nav-number">7.3.</span> <span class="nav-text">应用拦截器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http进度事件"><span class="nav-number">8.</span> <span class="nav-text">Http进度事件</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Juphy"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Juphy</p>
  <div class="site-description" itemprop="description">挽留天涯挽留人,挽留岁月挽留你。它就是挽留,我就是使挽留的人,只看谁是要被挽留。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Juphy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">79k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:12</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

</body>
</html>
